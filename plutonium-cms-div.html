<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../iron-pages/iron-pages.html">

<link rel="import" href="plutonium-cms-image-display.html">
<link rel="import" href="plutonium-cms-text-display.html">
<link rel="import" href="plutonium-cms-video-display.html">

<!--
`plutonium-cms`
CMS related components.

@demo demo/index_div.html 
-->

<dom-module id="plutonium-cms-div">
    <template>
        <style include="iron-flex">
            :host {
                display: inline-block;
            }
            :host h1 {
                margin-top: 10px;
                margin-bottom: 10px;
            }
        </style>
        <h1>[[contentModel.title]]</h1>
        <div id="contentContainer" class="layout vertical"></div>
    </template>

    <script>
        Polymer({
            is: 'plutonium-cms-div',
            properties: {
                title: {
                    type: String,
                    notify: true
                },
                contentModel: {
                    type: Object,
                    notify: true,
                    value: {
                        sections: []
                    }
                },
            },
            observers: [
                'sectionsAddedOrRemoved(contentModel.sections.*)'
            ],
            attached: function () {
                this.contentModel.sections.forEach(function (s, index) {
                    var display = document.createElement(this.identifyDisplay(s.type));
                    display.id = 'contentSection' + index;
                    display.contentModel = s;
                    display.verticalAlign = 'auto';
                    display.horizontalAlign = 'auto';
                    this.$.contentContainer.appendChild(display);
                }, this);
            },
            detached: function () {
                var children = this.$.contentContainer.children;
                for (var i = 0; i < children.length; i++) {
                    this.$.contentContainer.removeChild(children[i]);
                }
            },
            sectionsAddedOrRemoved: function (changeRecord) {
                if (changeRecord.splices) {
                    changeRecord.splices.indexSplices.forEach(function (s) {
                        s.removed.forEach(function (user, index) {
                            console.log(user.name + ' was removed');
                            this.$.contentContainer.removeChild(this.$$('#contentSection' + index));
                        });
                        for (var i = 0; i < s.addedCount; i++) {
                            var index = s.index + i;
                            var newUser = s.object[index];
                            console.log('section ' + newUser.name + ' added at index ' + index);

                            var display = document.createElement(this.identifyDisplay(newUser.type));
                            display.id = 'contentSection' + index;
                            display.contentModel = this.contentModel;
                            display.verticalAlign = 'auto';
                            display.horizontalAlign = 'auto';
                            this.$.contentContainer.appendChild(display);
                        }
                    }, this);
                } else {

//                    var children = this.$.contentContainer.children;
//                    for (var i = 0; i < children.length; i++) {
//                        this.$.contentContainer.removeChild(children[i]);
//                    }
//
////                    var self = this;
//                    changeRecord.value.forEach(function (s, index) {
//                        var display = document.createElement(this.identifyDisplay(s.type));
//                        display.id = 'contentSection' + index;
//                        display.contentModel = s;
//                        display.verticalAlign = 'auto';
//                        display.horizontalAlign = 'auto';
//                        this.$.contentContainer.appendChild(display);
//                    }, this);

                }

                Polymer.dom.flush();
            },
            indexOfSection: function (name) {
                var s = this.contentModel.sections;
                var index = s.indexOf(
                        s.filter(function (section) {
                            return (section.name === name);
                        }, this)[0]);
                return index;
            },
            identifyDisplay: function (type) {
                return 'plutonium-cms-' + type + '-display';
            }
        });
    </script>
</dom-module>
